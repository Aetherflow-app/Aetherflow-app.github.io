<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherFlow - Pricing</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/auth-modal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <!-- 引入Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>AetherFlow</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="pricing.html" class="active">Pricing</a></li>
                    <li><a href="terms-of-service.html">Terms</a></li>
                    <li><a href="privacy-policy.html">Privacy</a></li>
                    <li><a href="refund-policy.html">Refunds</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <!-- 登录/注册按钮 -->
                <button class="auth-button" id="login-button">Login / Register</button>
                
                <!-- 用户个人资料 (默认隐藏) -->
                <div class="user-profile" style="display: none;">
                    <div class="user-avatar">U</div>
                    <span class="user-name">User</span>
                </div>
            </div>
        </div>
    </header>

    <section class="pricing-hero">
        <div class="container">
            <div class="pricing-hero-content">
                <h1>Simple, Transparent Pricing</h1>
                <p>Choose the plan that best fits your needs</p>
            </div>
        </div>
    </section>

    <section class="pricing-details">
        <div class="container">
            <div class="pricing-tabs">
                <button class="pricing-tab active" onclick="showMonthly()">Monthly</button>
                <button class="pricing-tab" onclick="showAnnual()">Annual (Save 33%)</button>
            </div>

            <div class="pricing-cards-container">
                <div class="pricing-cards">
                    <div class="pricing-card free">
                        <div class="card-header">
                            <h3>Free</h3>
                            <div class="price">$0</div>
                            <p>Forever</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 5 prompts</li>
                                <li>3 optimization attempts daily</li>
                                <li>Basic features access</li>
                                <li>Single device usage</li>
                                <li>Community support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="https://chrome.google.com/webstore/detail/aetherflow/ldpadjcdbfndeghcklogoppmbnmphbki" class="btn btn-outline">Get Started</a>
                        </div>
                    </div>
                    <div class="pricing-card premium monthly-plan">
                        <div class="most-popular">Most Popular</div>
                        <div class="card-header">
                            <h3>Pro</h3>
                            <div class="price">$4.99</div>
                            <p>per month</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary monthly-checkout" data-plan="monthly">Upgrade Now</a>
                        </div>
                    </div>
                    <div class="pricing-card premium annual-plan" style="display: none;">
                        <div class="best-value">Best Value</div>
                        <div class="card-header">
                            <h3>Pro Annual</h3>
                            <div class="price">$39.99</div>
                            <p>per year (Save 33%)</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                                <li>Early access to new features</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary annual-checkout" data-plan="annual">Upgrade Now</a>
                        </div>
                    </div>
                </div>
                <p class="subscription-note">All subscriptions automatically renew unless cancelled at least 24 hours before the end of the current period. You can manage your subscription in your account settings.</p>
            </div>
        </div>
    </section>

    <section class="features-comparison">
        <div class="container">
            <h2>Feature Comparison</h2>
            <div class="comparison-table-wrapper">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Free</th>
                            <th>Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Prompt Storage</td>
                            <td>5 prompts</td>
                            <td>100 prompts</td>
                        </tr>
                        <tr>
                            <td>Daily Optimization Attempts</td>
                            <td>3</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td>Quick Prompt Input</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Basic Prompt Library</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Multi-device Sync</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Prompt Categories</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Advanced Search</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Custom Tags</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Data Export</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Priority Support</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Early Access to New Features</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="faq">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-items">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How does the billing work?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>For monthly plans, you will be billed every month on the same date you initially subscribed. For annual plans, you will be billed once per year. All plans automatically renew unless cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Can I upgrade from monthly to annual?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, you can upgrade from a monthly to an annual subscription at any time. When you upgrade, you'll be charged for the annual plan, and your monthly subscription will be cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How do I cancel my subscription?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>You can cancel your subscription at any time through the AetherFlow extension settings or by accessing the customer portal. After cancellation, you'll still have access to Pro features until the end of your current billing period.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>What happens to my data if I downgrade?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>If you downgrade from Pro to Free, all your prompts will be preserved, but you'll only be able to actively use 5 prompts. The rest will be marked as read-only until you upgrade again.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Do you offer refunds?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, we offer a 14-day refund window for new subscriptions. If you're not satisfied with our service during this period, you may request a full refund. Please refer to our <a href="refund-policy.html">Refund Policy</a> for more details.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Which payment methods do you accept?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>We accept all major credit cards (Visa, MasterCard, American Express), as well as PayPal. All payments are securely processed through Paddle, our payment processor.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta">
        <div class="container">
            <h2>Ready to Enhance Your AI Experience?</h2>
            <p>Join thousands of users who are getting better results with AetherFlow Pro</p>
            <a href="#" class="btn btn-large" onclick="scrollToPlans()">Choose Your Plan</a>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>AetherFlow</h2>
                    <p>Enhancing your AI experience</p>
                </div>
                <div class="footer-links">
                    <div class="footer-links-section">
                        <h3>Company</h3>
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li><a href="pricing.html">Pricing</a></li>
                            <li><a href="contact.html">Contact</a></li>
                        </ul>
                    </div>
                    <div class="footer-links-section">
                        <h3>Legal</h3>
                    <ul>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="refund-policy.html">Refund Policy</a></li>
                    </ul>
                </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 AetherFlow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- 加载Firebase配置和认证服务 -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-service.js"></script>
    <script src="js/auth-modal.js"></script>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            
            // 初始化Firebase
            initializeFirebase();
            
            // 创建认证模态窗口
            window.authModal = new AuthModal();
            
            // 绑定登录按钮点击事件
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.addEventListener('click', function() {
                    window.authModal.open();
                });
            }
            
            // 监听认证状态变化
            authService.onAuthStateChanged(function(user) {
                console.log('认证状态变化:', user ? '已登录' : '未登录');
                
                // 处理结账意图
                if (user) {
                    handleCheckoutIntent(user);
                }
            });
            
            // 初始化支付处理
            initializePaddleCheckout();
            
            // 初始化价格选项卡
            document.querySelectorAll('.pricing-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.pricing-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.innerText.includes('Monthly')) {
                        showMonthly();
                    } else {
                        showAnnual();
                    }
                });
            });
        });
        
        // 显示月度计划
        function showMonthly() {
            document.querySelector('.monthly-plan').style.display = 'block';
            document.querySelector('.annual-plan').style.display = 'none';
            document.querySelectorAll('.pricing-tab')[0].classList.add('active');
            document.querySelectorAll('.pricing-tab')[1].classList.remove('active');
        }
        
        // 显示年度计划
        function showAnnual() {
            document.querySelector('.monthly-plan').style.display = 'none';
            document.querySelector('.annual-plan').style.display = 'block';
            document.querySelectorAll('.pricing-tab')[0].classList.remove('active');
            document.querySelectorAll('.pricing-tab')[1].classList.add('active');
        }
        
        // 初始化Paddle
        function initializePaddle() {
            // 获取URL参数中的环境设置
            const urlParams = new URLSearchParams(window.location.search);
            const env = urlParams.get('env');
            
            // 判断是否使用沙盒环境
            const isSandbox = env === 'sandbox' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            // 设置正确的供应商ID和环境
            const vendorId = isSandbox ? '29838' : '223800'; // 沙盒 : 生产
            
            const paddleOptions = { 
                vendor: vendorId,
                eventCallback: handlePaddleEvent
            };
            
            // 添加适当的client token
            if (!isSandbox) {
                paddleOptions.token = 'live_74080bad93a7d3b962f98a52c93'; // 生产环境
            } else {
                paddleOptions.token = 'test_c624a7a4c9993fc8965d9c37db6'; // 沙盒环境
                Paddle.Environment.set('sandbox'); // 设置沙盒环境
                
                // 显示沙盒提示
                const banner = document.createElement('div');
                banner.style.background = '#FFC107';
                banner.style.color = '#000';
                banner.style.padding = '10px';
                banner.style.textAlign = 'center';
                banner.style.fontWeight = 'bold';
                banner.textContent = 'SANDBOX MODE - FOR TESTING ONLY';
                document.body.insertBefore(banner, document.body.firstChild);
            }
            
            Paddle.Setup(paddleOptions);
            console.log(`Paddle initialized in ${isSandbox ? 'SANDBOX' : 'PRODUCTION'} mode`);
        }
        
        // 处理Paddle事件
        function handlePaddleEvent(eventData) {
            console.log('Paddle event:', eventData);
            
            if (eventData.name === 'checkout.completed') {
                // 支付完成，重定向到成功页面
                const user = firebase.auth().currentUser;
                if (user) {
                    const data = eventData.data;
                    const checkoutId = data.checkout.id;
                    const planType = document.querySelector('.annual-plan').style.display === 'none' ? 'monthly' : 'annual';
                    
                    // 重定向到成功页面，并传递用户ID、订单ID和计划类型
                    window.location.href = `success.html?uid=${user.uid}&checkout=${checkoutId}&plan=${planType}`;
                } else {
                    // 如果用户未登录，直接重定向到成功页面
                    window.location.href = 'success.html';
                }
            }
        }
        
        // 启动支付流程
        function startCheckout(plan) {
            // 获取当前用户信息
            const user = firebase.auth().currentUser;
            
            // 获取URL参数中的环境设置
            const urlParams = new URLSearchParams(window.location.search);
            const env = urlParams.get('env');
            
            // 判断是否使用沙盒环境
            const isSandbox = env === 'sandbox' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            // 设置商品ID
            let priceId;
            if (isSandbox) {
                // 沙盒环境
                priceId = plan === 'monthly' ? 'pri_01jrw0em3kydrg4rw523w6s574' : 'pri_01jrw0f7y1kfw9jc967eswbnrs';
            } else {
                // 生产环境
                priceId = plan === 'monthly' ? 'pri_01jrfcwajex91zya4346h9ek32' : 'pri_01jrfcz25f4zdktr7rtt1pnzpw';
            }
            
            // 准备Paddle Checkout配置
            const checkoutOptions = {
                settings: {
                    displayMode: 'overlay',
                    theme: 'light',
                    locale: 'en'
                },
                items: [
                    {
                        priceId: priceId,
                        quantity: 1
                    }
                ],
                customer: {
                    email: user.email,
                    customerId: user.uid
                },
                passthrough: JSON.stringify({
                    userId: user.uid,
                    planType: plan,
                    source: 'website'
                }),
                successCallback: (data) => {
                    console.log('Checkout success:', data);
                }
            };
            
            // 启动Paddle Checkout
            Paddle.Checkout.open(checkoutOptions);
        }

        // 初始化支付处理
        function initializePaddleCheckout() {
            console.log('初始化 Paddle 结账');
            
            // 检查是否处于沙盒环境
            const isSandbox = isInSandboxMode();
            const environment = isSandbox ? 'sandbox' : 'production';
            console.log(`当前环境: ${environment}`);
            
            // 环境标识
            if (isSandbox) {
                const envBadge = document.createElement('div');
                envBadge.className = 'environment-badge sandbox';
                envBadge.textContent = '沙盒测试';
                document.body.appendChild(envBadge);
            }
            
            // 获取来源参数
            const source = getSourceParam();
            
            // 设置 Paddle
            Paddle.Environment.set(environment);
            Paddle.Setup({
                vendor: getPaddleVendorId()
            });
            
            // 绑定月度订阅按钮点击事件
            document.querySelectorAll('.monthly-checkout').forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    await handleCheckout('monthly', source);
                });
            });
            
            // 绑定年度订阅按钮点击事件
            document.querySelectorAll('.annual-checkout').forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    await handleCheckout('annual', source);
                });
            });
        }

        // 处理结账请求
        async function handleCheckout(planType, source = 'website') {
            console.log(`开始${planType}计划结账流程，来源: ${source}`);
            
            try {
                // 先检查用户是否已登录
                const user = await authService.getCurrentUser();
                
                if (!user) {
                    console.log('用户未登录，显示登录模态窗口');
                    // 保存用户意图
                    localStorage.setItem('checkout_intent', JSON.stringify({
                        planType,
                        source,
                        timestamp: Date.now()
                    }));
                    
                    // 显示登录模态窗口
                    if (window.authModal) {
                        window.authModal.open();
                        
                        // 显示提示信息
                        const modalContent = document.querySelector('.auth-modal-content');
                        if (modalContent) {
                            const checkoutNotice = document.createElement('div');
                            checkoutNotice.className = 'checkout-notice';
                            checkoutNotice.innerHTML = '请先登录再继续订阅流程';
                            modalContent.insertBefore(checkoutNotice, modalContent.firstChild);
                        }
                    } else {
                        alert('请先登录后再进行订阅');
                    }
                    
                    return;
                }
                
                // 用户已登录，继续结账流程
                console.log('用户已登录，继续结账流程');
                
                // 显示加载状态
                showLoading();
                
                // 获取产品ID
                const productId = getProductId(planType);
                if (!productId) {
                    hideLoading();
                    console.error('无法获取产品ID');
                    alert('订阅初始化失败，请稍后再试');
                    return;
                }
                
                // 设置结账参数
                const checkoutParams = {
                    items: [{
                        priceId: productId,
                        quantity: 1
                    }],
                    customer: {
                        email: user.email,
                        userId: user.uid
                    },
                    successUrl: window.location.origin + '/success.html?checkoutId={checkout.id}',
                    cancelUrl: window.location.origin + '/cancel.html'
                };
                
                // 添加UTM参数
                if (source && source !== 'website') {
                    checkoutParams.utm = {
                        source: source,
                        medium: 'extension',
                        campaign: 'upgrade'
                    };
                }
                
                console.log('结账参数:', checkoutParams);
                
                // 打开Paddle结账
                const checkout = await Paddle.Checkout.open(checkoutParams);
                console.log('结账成功打开:', checkout);
                
                // 隐藏加载状态
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('结账过程中出错:', error);
                alert('启动结账失败: ' + (error.message || '未知错误'));
            }
        }

        // 监听认证状态变化，处理结账意图
        function handleCheckoutIntent(user) {
            if (!user) return;
            
            // 检查是否有未完成的结账意图
            const intentJson = localStorage.getItem('checkout_intent');
            if (!intentJson) return;
            
            try {
                const intent = JSON.parse(intentJson);
                
                // 验证意图是否有效（30分钟内）
                const now = Date.now();
                const intentTime = intent.timestamp || 0;
                const isValid = now - intentTime < 30 * 60 * 1000; // 30分钟
                
                if (isValid && intent.planType) {
                    console.log('发现有效的结账意图:', intent);
                    
                    // 清除意图
                    localStorage.removeItem('checkout_intent');
                    
                    // 等待一小段时间后继续结账流程
                    setTimeout(() => {
                        handleCheckout(intent.planType, intent.source || 'website');
                    }, 1000);
                } else {
                    // 清除过期意图
                    localStorage.removeItem('checkout_intent');
                }
            } catch (error) {
                console.error('处理结账意图时出错:', error);
                localStorage.removeItem('checkout_intent');
            }
        }

        // 显示加载状态
        function showLoading() {
            const loadingElement = document.createElement('div');
            loadingElement.className = 'loading-overlay';
            loadingElement.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(loadingElement);
        }

        // 隐藏加载状态
        function hideLoading() {
            const loadingElement = document.querySelector('.loading-overlay');
            if (loadingElement) {
                loadingElement.remove();
            }
        }
    </script>
</body>
</html> 