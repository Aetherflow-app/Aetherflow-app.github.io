<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherFlow - Pricing</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- 引入Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>AetherFlow</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="pricing.html" class="active">Pricing</a></li>
                    <li><a href="terms-of-service.html">Terms</a></li>
                    <li><a href="privacy-policy.html">Privacy</a></li>
                    <li><a href="refund-policy.html">Refunds</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="#" id="auth-button" class="auth-button">Sign in</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="pricing-hero">
        <div class="container">
            <div class="pricing-hero-content">
                <h1>Simple, Transparent Pricing</h1>
                <p>Choose the plan that best fits your needs</p>
            </div>
        </div>
    </section>

    <section class="pricing-details">
        <div class="container">
            <div class="pricing-tabs">
                <button class="pricing-tab active" onclick="showMonthly()">Monthly</button>
                <button class="pricing-tab" onclick="showAnnual()">Annual (Save 33%)</button>
            </div>

            <div class="pricing-cards-container">
                <div class="pricing-cards">
                    <div class="pricing-card free">
                        <div class="card-header">
                            <h3>Free</h3>
                            <div class="price">$0</div>
                            <p>Forever</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 5 prompts</li>
                                <li>3 optimization attempts daily</li>
                                <li>Basic features access</li>
                                <li>Single device usage</li>
                                <li>Community support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="https://chrome.google.com/webstore/detail/aetherflow/ldpadjcdbfndeghcklogoppmbnmphbki" class="btn btn-outline">Get Started</a>
                        </div>
                    </div>
                    <div class="pricing-card premium monthly-plan">
                        <div class="most-popular">Most Popular</div>
                        <div class="card-header">
                            <h3>Pro</h3>
                            <div class="price">$3.99</div>
                            <p>per month</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary monthly-checkout" data-plan="monthly">Upgrade Now</a>
                        </div>
                    </div>
                    <div class="pricing-card premium annual-plan" style="display: none;">
                        <div class="best-value">Best Value</div>
                        <div class="card-header">
                            <h3>Pro Annual</h3>
                            <div class="price">$39.99</div>
                            <p>per year (Save 33%)</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                                <li>Early access to new features</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary annual-checkout" data-plan="annual">Upgrade Now</a>
                        </div>
                    </div>
                </div>
                <p class="subscription-note">All subscriptions automatically renew unless cancelled at least 24 hours before the end of the current period. You can manage your subscription in your account settings.</p>
            </div>
        </div>
    </section>

    <section class="features-comparison">
        <div class="container">
            <h2>Feature Comparison</h2>
            <div class="comparison-table-wrapper">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Free</th>
                            <th>Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Prompt Storage</td>
                            <td>5 prompts</td>
                            <td>100 prompts</td>
                        </tr>
                        <tr>
                            <td>Daily Optimization Attempts</td>
                            <td>3</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td>Quick Prompt Input</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Basic Prompt Library</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Multi-device Sync</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Prompt Categories</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Advanced Search</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Custom Tags</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Data Export</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Priority Support</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Early Access to New Features</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="faq">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-items">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How does the billing work?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>For monthly plans, you will be billed every month on the same date you initially subscribed. For annual plans, you will be billed once per year. All plans automatically renew unless cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Can I upgrade from monthly to annual?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, you can upgrade from a monthly to an annual subscription at any time. When you upgrade, you'll be charged for the annual plan, and your monthly subscription will be cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How do I cancel my subscription?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>You can cancel your subscription at any time through the AetherFlow extension settings or by accessing the customer portal. After cancellation, you'll still have access to Pro features until the end of your current billing period.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>What happens to my data if I downgrade?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>If you downgrade from Pro to Free, all your prompts will be preserved, but you'll only be able to actively use 5 prompts. The rest will be marked as read-only until you upgrade again.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Do you offer refunds?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, we offer a 14-day refund window for new subscriptions. If you're not satisfied with our service during this period, you may request a full refund. Please refer to our <a href="refund-policy.html">Refund Policy</a> for more details.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Which payment methods do you accept?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>We accept all major credit cards (Visa, MasterCard, American Express), as well as PayPal. All payments are securely processed through Paddle, our payment processor.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta">
        <div class="container">
            <h2>Ready to Enhance Your AI Experience?</h2>
            <p>Join thousands of users who are getting better results with AetherFlow Pro</p>
            <a href="#" class="btn btn-large" onclick="scrollToPlans()">Choose Your Plan</a>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>AetherFlow</h2>
                    <p>AI Prompt Management Chrome Extension</p>
                </div>
                <div class="footer-links">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="refund-policy.html">Refund Policy</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="https://chrome.google.com/webstore/detail/aetherflow/ldpadjcdbfndeghcklogoppmbnmphbki">Chrome Store</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <p>Email: support@aetherflow.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 AetherFlow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化FAQ切换
            const faqQuestions = document.querySelectorAll('.faq-question');
            
            faqQuestions.forEach(item => {
                item.addEventListener('click', function() {
                    const faqItem = item.parentNode;
                    const answer = faqItem.querySelector('.faq-answer');
                    const toggle = item.querySelector('.faq-toggle');
                    
                    // 切换class
                    faqItem.classList.toggle('open');
                    
                    // 更新切换图标
                    if (faqItem.classList.contains('open')) {
                        toggle.textContent = '-';
                        answer.style.maxHeight = answer.scrollHeight + 'px';
                    } else {
                        toggle.textContent = '+';
                        answer.style.maxHeight = '0';
                    }
                });
            });
            
            // 初始化Paddle支付
            initializePaddle();
            
            // 设置结账点击处理函数
            document.querySelector('.monthly-checkout').addEventListener('click', function(e) {
                e.preventDefault();
                handleCheckoutButtonClick('monthly');
            });
            
            document.querySelector('.annual-checkout').addEventListener('click', function(e) {
                e.preventDefault();
                handleCheckoutButtonClick('annual');
            });
            
            // 初始化Firebase
            initFirebase();
            
            // 设置认证按钮监听器
            setupAuthUI();
        });
        
        // 切换月度和年度价格
        function showMonthly() {
            document.querySelector('.pricing-tab.active').classList.remove('active');
            document.querySelectorAll('.pricing-tab')[0].classList.add('active');
            document.querySelector('.monthly-plan').style.display = 'block';
            document.querySelector('.annual-plan').style.display = 'none';
        }
        
        function showAnnual() {
            document.querySelector('.pricing-tab.active').classList.remove('active');
            document.querySelectorAll('.pricing-tab')[1].classList.add('active');
            document.querySelector('.monthly-plan').style.display = 'none';
            document.querySelector('.annual-plan').style.display = 'block';
        }
        
        // 滚动到价格计划部分
        function scrollToPlans() {
            document.querySelector('.pricing-details').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 初始化Paddle支付系统
        function initializePaddle() {
            // 1. 检查URL参数是否有明确的环境指定
            const urlParams = new URLSearchParams(window.location.search);
            const envParam = urlParams.get('env');
            
            // 2. 判断环境
            // 明确参数指定的环境 > 域名判断环境
            let useSandbox = false;
            
            // 如果URL参数明确指定了环境
            if (envParam) {
                useSandbox = envParam === 'sandbox' || envParam === 'test';
            } else {
                // 判断开发环境
                const isLocalhost = window.location.hostname === 'localhost' || 
                                   window.location.hostname === '127.0.0.1' ||
                                   window.location.hostname.includes('github.dev');
                                   
                // 判断非生产环境
                const isNonProduction = isLocalhost || 
                                       window.location.hostname.includes('github.io') ||
                                       window.location.hostname.includes('test');
                                   
                // 非生产环境默认使用沙盒
                useSandbox = isNonProduction;
            }
            
            // 3. 设置环境和初始化Paddle
            if (useSandbox) {
                Paddle.Environment.set('sandbox');
                console.log('Using Paddle SANDBOX environment');
            } else {
                console.log('Using Paddle PRODUCTION environment');
            }
            
            // 初始化Paddle
            Paddle.Initialize({
                token: useSandbox ? 'test_c624a7a4c9993fc8965d9c37db6' : 'live_74080bad93a7d3b962f98a52c93',
                eventCallback: function(eventData) {
                    console.log('Paddle event:', eventData);
                    
                    // 处理结账事件
                    if (eventData.name === 'checkout.completed') {
                        // 支付成功，处理跳转
                        handleCheckoutCompleted(eventData.data);
                    }
                }
            });
            
            // 4. 记录当前环境，用于调试和测试
            localStorage.setItem('aetherflow_env', useSandbox ? 'sandbox' : 'production');
            
            // 如果需要在UI上显示当前环境（仅在非生产环境）
            if (useSandbox) {
                const envIndicator = document.createElement('div');
                envIndicator.style.position = 'fixed';
                envIndicator.style.bottom = '10px';
                envIndicator.style.left = '10px';
                envIndicator.style.padding = '5px 10px';
                envIndicator.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                envIndicator.style.color = '#900';
                envIndicator.style.borderRadius = '4px';
                envIndicator.style.fontSize = '12px';
                envIndicator.style.zIndex = '9999';
                envIndicator.textContent = 'SANDBOX MODE';
                document.body.appendChild(envIndicator);
            }
        }
        
        // 打开结账窗口
        function openCheckout(planType) {
            // 获取来源信息
            const source = getUtmSource();
            
            // 确定使用哪个价格ID
            const priceId = getPriceIdForPlan(planType);
            
            // 准备自定义数据
            const customData = {
                plan: planType,
                source: source || 'website',
                referrer: document.referrer || 'direct'
            };
            
            // 获取URL参数并传递
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('utm_campaign')) {
                customData.utm_campaign = urlParams.get('utm_campaign');
            }
            if (urlParams.has('utm_content')) {
                customData.utm_content = urlParams.get('utm_content');
            }
            
            // 打开Paddle结账
            Paddle.Checkout.open({
                items: [
                    {
                        priceId: priceId,
                        quantity: 1
                    }
                ],
                customData: customData,
                settings: {
                    displayMode: 'overlay',
                    theme: 'light',
                    locale: 'en',
                    successUrl: getSuccessUrl(planType, source)
                }
            });
        }
        
        // 根据计划类型获取价格ID
        function getPriceIdForPlan(planType) {
            // 获取当前环境
            const useSandbox = localStorage.getItem('aetherflow_env') === 'sandbox';
            
            // 根据环境和计划类型返回对应的价格ID
            if (useSandbox) {
                // 沙盒环境的价格ID
                return planType === 'annual' ? 'pri_01jrw0f7y1kfw9jc967eswbnrs' : 'pri_01jrw0em3kydrg4rw523w6s574';
            } else {
                // 生产环境的价格ID
                return planType === 'annual' ? 'pri_01jrfcz25f4zdktr7rtt1pnzpw' : 'pri_01jrfcwajex91zya4346h9ek32';
            }
        }
        
        // 获取UTM来源
        function getUtmSource() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('utm_source') || localStorage.getItem('aetherflow_utm_source') || null;
        }
        
        // 构建成功URL
        function getSuccessUrl(planType, source) {
            // 获取基础URL
            let baseUrl;
            
            // 检查环境
            const useSandbox = localStorage.getItem('aetherflow_env') === 'sandbox';
            
            // 如果是localhost，使用相对路径
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                baseUrl = '/success.html';
            } else {
                // 使用完整URL
                baseUrl = window.location.origin + '/success.html';
            }
            
            // 构建URL参数
            const params = new URLSearchParams();
            params.set('plan', planType);
            if (source) {
                params.set('source', source);
            }
            
            // 添加环境参数（仅在沙盒环境）
            if (useSandbox) {
                params.set('env', 'sandbox');
            }
            
            return baseUrl + '?' + params.toString();
        }
        
        // 处理结账完成事件
        function handleCheckoutCompleted(data) {
            console.log('Checkout completed:', data);
            
            // 从事件数据中获取信息
            const checkoutId = data.checkout?.id;
            const planType = data.items?.[0]?.price?.productType || 'monthly';
            
            // 构建跳转URL
            let redirectUrl = 'success.html?checkout=' + encodeURIComponent(checkoutId) + '&plan=' + planType;
            
            // 跳转到成功页面
            window.location.href = redirectUrl;
        }
        
        // 保存UTM来源到localStorage（如果存在）
        function saveUtmParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('utm_source')) {
                localStorage.setItem('aetherflow_utm_source', urlParams.get('utm_source'));
            }
            if (urlParams.has('utm_campaign')) {
                localStorage.setItem('aetherflow_utm_campaign', urlParams.get('utm_campaign'));
            }
        }
        
        // 在页面加载时保存UTM参数
        saveUtmParameters();
        
        // Firebase配置和初始化
        function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCulWQxvrzxDOLGOxzi2ngj9n0DwzvqJFw",
                authDomain: "aetherflow-b6459.firebaseapp.com",
                projectId: "aetherflow-b6459",
                storageBucket: "aetherflow-b6459.firebasestorage.app",
                messagingSenderId: "423266303314",
                appId: "1:423266303314:web:9cbf8adb847f043bd34e8b",
                measurementId: "G-ZD5E2WY22N"
            };
            
            // 初始化Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // 检查URL中是否有认证令牌
            checkForAuthToken();
            
            // 监听认证状态变化
            firebase.auth().onAuthStateChanged(handleAuthStateChanged);
        }
        
        // 处理认证状态变化
        function handleAuthStateChanged(user) {
            const authButton = document.getElementById('auth-button');
            
            if (user) {
                // 用户已登录
                console.log('用户已登录:', user.email);
                authButton.textContent = user.displayName || user.email.split('@')[0];
                authButton.classList.add('auth-logged-in');
                
                // 保存用户状态到本地存储
                localStorage.setItem('aetherflow_user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
            } else {
                // 用户未登录
                console.log('用户未登录');
                authButton.textContent = 'Sign in';
                authButton.classList.remove('auth-logged-in');
                
                // 清除本地存储中的用户信息
                localStorage.removeItem('aetherflow_user');
            }
        }
        
        // 设置认证UI
        function setupAuthUI() {
            const authButton = document.getElementById('auth-button');
            
            authButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (firebase.auth().currentUser) {
                    // 如果用户已登录，显示用户菜单
                    showUserMenu(this);
                } else {
                    // 如果用户未登录，显示登录模态框
                    showAuthModal();
                }
            });
        }
        
        // 显示用户菜单
        function showUserMenu(buttonElement) {
            // 检查是否已有菜单
            let menu = document.getElementById('user-menu');
            
            if (menu) {
                // 如果菜单已存在，切换显示/隐藏
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
                return;
            }
            
            // 创建用户菜单
            menu = document.createElement('div');
            menu.id = 'user-menu';
            menu.className = 'user-menu';
            
            // 添加菜单项
            menu.innerHTML = `
                <div class="user-menu-item" id="sign-out">Sign out</div>
            `;
            
            // 定位菜单
            const rect = buttonElement.getBoundingClientRect();
            menu.style.position = 'absolute';
            menu.style.top = (rect.bottom + window.scrollY) + 'px';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.style.backgroundColor = '#fff';
            menu.style.boxShadow = 'var(--box-shadow)';
            menu.style.borderRadius = 'var(--border-radius)';
            menu.style.padding = '8px 0';
            menu.style.zIndex = '1000';
            menu.style.minWidth = '150px';
            
            // 菜单项样式
            const menuItems = menu.querySelectorAll('.user-menu-item');
            menuItems.forEach(item => {
                item.style.padding = '10px 15px';
                item.style.cursor = 'pointer';
                item.style.transition = 'var(--transition)';
                
                // 添加悬停效果
                item.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#f9fafb';
                });
                item.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // 添加登出点击事件
            menu.querySelector('#sign-out').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    menu.style.display = 'none';
                }).catch(error => {
                    console.error('登出失败:', error);
                });
            });
            
            // 添加到DOM
            document.body.appendChild(menu);
            
            // 点击文档其他地方关闭菜单
            document.addEventListener('click', function closeMenu(e) {
                if (e.target !== buttonElement && !menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }
        
        // 显示认证模态框
        function showAuthModal() {
            // 检查是否已有模态框
            let modal = document.getElementById('auth-modal');
            
            if (modal) {
                modal.style.display = 'flex';
                return;
            }
            
            // 创建模态框
            modal = document.createElement('div');
            modal.id = 'auth-modal';
            modal.className = 'auth-modal';
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'auth-modal-content';
            modalContent.style.width = '100%';
            modalContent.style.maxWidth = '400px';
            modalContent.style.backgroundColor = '#fff';
            modalContent.style.borderRadius = 'var(--border-radius-lg)';
            modalContent.style.padding = '24px';
            modalContent.style.boxShadow = 'var(--box-shadow-lg)';
            modalContent.style.position = 'relative';
            
            // 添加关闭按钮
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '15px';
            closeButton.style.right = '15px';
            closeButton.style.border = 'none';
            closeButton.style.background = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.color = 'var(--gray)';
            closeButton.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // 创建标签页按钮
            const tabButtons = document.createElement('div');
            tabButtons.className = 'auth-tabs';
            tabButtons.style.display = 'flex';
            tabButtons.style.marginBottom = '20px';
            tabButtons.style.borderBottom = '1px solid #eee';
            
            const loginTab = document.createElement('button');
            loginTab.textContent = 'Sign in';
            loginTab.className = 'auth-tab active';
            loginTab.dataset.tab = 'login';
            loginTab.style.flex = '1';
            loginTab.style.padding = '10px';
            loginTab.style.background = 'none';
            loginTab.style.border = 'none';
            loginTab.style.borderBottom = '2px solid var(--primary)';
            loginTab.style.color = 'var(--primary)';
            loginTab.style.fontWeight = '600';
            loginTab.style.cursor = 'pointer';
            
            const registerTab = document.createElement('button');
            registerTab.textContent = 'Sign up';
            registerTab.className = 'auth-tab';
            registerTab.dataset.tab = 'register';
            registerTab.style.flex = '1';
            registerTab.style.padding = '10px';
            registerTab.style.background = 'none';
            registerTab.style.border = 'none';
            registerTab.style.borderBottom = '2px solid transparent';
            registerTab.style.color = 'var(--gray)';
            registerTab.style.fontWeight = '600';
            registerTab.style.cursor = 'pointer';
            
            // 添加标签页按钮事件
            loginTab.addEventListener('click', function() {
                registerTab.style.borderBottom = '2px solid transparent';
                registerTab.style.color = 'var(--gray)';
                this.style.borderBottom = '2px solid var(--primary)';
                this.style.color = 'var(--primary)';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            });
            
            registerTab.addEventListener('click', function() {
                loginTab.style.borderBottom = '2px solid transparent';
                loginTab.style.color = 'var(--gray)';
                this.style.borderBottom = '2px solid var(--primary)';
                this.style.color = 'var(--primary)';
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });
            
            tabButtons.appendChild(loginTab);
            tabButtons.appendChild(registerTab);
            
            // 创建登录表单
            const loginForm = document.createElement('form');
            loginForm.id = 'login-form';
            loginForm.style.display = 'block';
            
            loginForm.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <label for="login-email" style="display: block; margin-bottom: 8px; font-weight: 500;">Email</label>
                    <input type="email" id="login-email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); outline: none;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="login-password" style="display: block; margin-bottom: 8px; font-weight: 500;">Password</label>
                    <input type="password" id="login-password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); outline: none;">
                </div>
                <div style="margin-bottom: 16px;">
                    <a href="#" id="forgot-password" style="font-size: 14px; color: var(--primary); text-decoration: none;">Forgot password?</a>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign in</button>
                <div style="margin-top: 20px; text-align: center;">
                    <p style="margin-bottom: 12px; color: var(--gray);">Or sign in with</p>
                    <button type="button" id="google-signin" class="btn btn-outline" style="width: 100%;">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 18px; margin-right: 8px; vertical-align: middle;">
                        Google
                    </button>
                </div>
            `;
            
            // 创建注册表单
            const registerForm = document.createElement('form');
            registerForm.id = 'register-form';
            registerForm.style.display = 'none';
            
            registerForm.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <label for="register-email" style="display: block; margin-bottom: 8px; font-weight: 500;">Email</label>
                    <input type="email" id="register-email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); outline: none;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="register-password" style="display: block; margin-bottom: 8px; font-weight: 500;">Password</label>
                    <input type="password" id="register-password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--border-radius); outline: none;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign up</button>
                <div style="margin-top: 20px; text-align: center;">
                    <p style="margin-bottom: 12px; color: var(--gray);">Or sign up with</p>
                    <button type="button" id="google-signup" class="btn btn-outline" style="width: 100%;">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 18px; margin-right: 8px; vertical-align: middle;">
                        Google
                    </button>
                </div>
            `;
            
            // 添加表单提交事件
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        modal.style.display = 'none';
                    })
                    .catch((error) => {
                        alert(`Login failed: ${error.message}`);
                    });
            });
            
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        modal.style.display = 'none';
                    })
                    .catch((error) => {
                        alert(`Registration failed: ${error.message}`);
                    });
            });
            
            // 组装模态框
            modalContent.appendChild(closeButton);
            modalContent.appendChild(tabButtons);
            modalContent.appendChild(loginForm);
            modalContent.appendChild(registerForm);
            modal.appendChild(modalContent);
            
            // 添加到DOM
            document.body.appendChild(modal);
            
            // 设置Google登录
            document.getElementById('google-signin').addEventListener('click', signInWithGoogle);
            document.getElementById('google-signup').addEventListener('click', signInWithGoogle);
            
            // 设置忘记密码
            document.getElementById('forgot-password').addEventListener('click', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                if (!email) {
                    alert('Please enter your email address.');
                    return;
                }
                
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        alert(`Password reset email sent to ${email}`);
                    })
                    .catch((error) => {
                        alert(`Error: ${error.message}`);
                    });
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Google登录
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    document.getElementById('auth-modal').style.display = 'none';
                })
                .catch((error) => {
                    alert(`Google sign in failed: ${error.message}`);
                });
        }
        
        // 处理支付按钮点击
        function handleCheckoutButtonClick(planType) {
            // 检查用户是否已登录
            if (!firebase.auth().currentUser) {
                // 用户未登录，显示登录模态框
                showAuthModal();
                // 存储计划类型，以便登录后继续
                localStorage.setItem('aetherflow_pending_plan', planType);
                return;
            }
            
            // 用户已登录，继续支付流程
            openCheckout(planType);
        }
        
        // 检查URL中的认证令牌
        function checkForAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                // 使用令牌登录
                firebase.auth().signInWithCustomToken(token)
                    .then(() => {
                        // 登录成功，清除URL参数
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // 检查是否有待处理的支付
                        const pendingPlan = localStorage.getItem('aetherflow_pending_plan');
                        if (pendingPlan) {
                            openCheckout(pendingPlan);
                            localStorage.removeItem('aetherflow_pending_plan');
                        }
                    })
                    .catch((error) => {
                        console.error('令牌登录失败:', error);
                    });
            }
        }
    </script>
</body>
</html> 