<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherFlow - Pricing</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- 引入Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    <!-- 引入Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>AetherFlow</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="pricing.html" class="active">Pricing</a></li>
                    <li><a href="terms-of-service.html">Terms</a></li>
                    <li><a href="privacy-policy.html">Privacy</a></li>
                    <li><a href="refund-policy.html">Refunds</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li id="auth-container">
                        <button id="auth-button" class="auth-button">Sign In</button>
                        <div id="auth-user-menu" class="auth-user-menu" style="display: none;">
                            <span id="user-display-name"></span>
                            <div id="auth-user-dropdown" class="auth-user-dropdown">
                                <div class="auth-user-dropdown-item" id="logout-button">Sign Out</div>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 认证模态框 -->
    <div id="auth-modal-overlay" class="auth-modal-overlay">
        <div class="auth-modal">
            <button id="auth-modal-close" class="auth-modal-close">&times;</button>
            
            <div id="auth-success-message" class="auth-success-message"></div>
            
            <div class="auth-tabs">
                <div id="login-tab" class="auth-tab active">Sign In</div>
                <div id="register-tab" class="auth-tab">Sign Up</div>
            </div>
            
            <div id="login-form" class="auth-form active">
                <div class="auth-form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                    <div id="login-email-error" class="auth-form-error"></div>
                </div>
                <div class="auth-form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                    <div id="login-password-error" class="auth-form-error"></div>
                    <a href="#" id="forgot-password" class="auth-reset-link">Forgot password?</a>
                </div>
                <button id="login-submit" class="auth-submit">Sign In</button>
                
                <div class="auth-divider">
                    <span>OR</span>
                </div>
                
                <button id="google-login" class="auth-social-button">
                    <img src="assets/google-icon.svg" alt="Google">
                    Sign in with Google
                </button>
            </div>
            
            <div id="register-form" class="auth-form">
                <div class="auth-form-group">
                    <label for="register-name">Name</label>
                    <input type="text" id="register-name" required>
                    <div id="register-name-error" class="auth-form-error"></div>
                </div>
                <div class="auth-form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                    <div id="register-email-error" class="auth-form-error"></div>
                </div>
                <div class="auth-form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required>
                    <div id="register-password-error" class="auth-form-error"></div>
                </div>
                <button id="register-submit" class="auth-submit">Sign Up</button>
            </div>
            
            <div id="reset-form" class="auth-form">
                <div class="auth-form-group">
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" required>
                    <div id="reset-email-error" class="auth-form-error"></div>
                </div>
                <button id="reset-submit" class="auth-submit">Reset Password</button>
                <div class="auth-footer">
                    <a href="#" id="back-to-login">Back to Sign In</a>
                </div>
            </div>
            
            <div id="auth-loading" class="auth-loading">
                <div class="auth-spinner"></div>
                <p>Please wait...</p>
            </div>
        </div>
    </div>

    <section class="pricing-hero">
        <div class="container">
            <div class="pricing-hero-content">
                <h1>Simple, Transparent Pricing</h1>
                <p>Choose the plan that best fits your needs</p>
            </div>
        </div>
    </section>

    <section class="pricing-details">
        <div class="container">
            <div class="pricing-tabs">
                <button class="pricing-tab active" onclick="showMonthly()">Monthly</button>
                <button class="pricing-tab" onclick="showAnnual()">Annual (Save 33%)</button>
            </div>

            <div class="pricing-cards-container">
                <div class="pricing-cards">
                    <div class="pricing-card free">
                        <div class="card-header">
                            <h3>Free</h3>
                            <div class="price">$0</div>
                            <p>Forever</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 5 prompts</li>
                                <li>3 optimization attempts daily</li>
                                <li>Basic features access</li>
                                <li>Single device usage</li>
                                <li>Community support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="https://chrome.google.com/webstore/detail/aetherflow/ldpadjcdbfndeghcklogoppmbnmphbki" class="btn btn-outline">Get Started</a>
                        </div>
                    </div>
                    <div class="pricing-card premium monthly-plan">
                        <div class="most-popular">Most Popular</div>
                        <div class="card-header">
                            <h3>Pro</h3>
                            <div class="price">$4.99</div>
                            <p>per month</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary monthly-checkout" data-plan="monthly">Upgrade Now</a>
                        </div>
                    </div>
                    <div class="pricing-card premium annual-plan" style="display: none;">
                        <div class="best-value">Best Value</div>
                        <div class="card-header">
                            <h3>Pro Annual</h3>
                            <div class="price">$39.99</div>
                            <p>per year (Save 33%)</p>
                        </div>
                        <div class="card-features">
                            <ul>
                                <li>Store up to 100 prompts</li>
                                <li>50 optimization attempts daily</li>
                                <li>All advanced features</li>
                                <li>Multi-device sync</li>
                                <li>Multi-format data export</li>
                                <li>Priority support</li>
                                <li>Early access to new features</li>
                            </ul>
                        </div>
                        <div class="card-action">
                            <a href="#" class="btn btn-primary annual-checkout" data-plan="annual">Upgrade Now</a>
                        </div>
                    </div>
                </div>
                <p class="subscription-note">All subscriptions automatically renew unless cancelled at least 24 hours before the end of the current period. You can manage your subscription in your account settings.</p>
            </div>
        </div>
    </section>

    <section class="features-comparison">
        <div class="container">
            <h2>Feature Comparison</h2>
            <div class="comparison-table-wrapper">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Free</th>
                            <th>Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Prompt Storage</td>
                            <td>5 prompts</td>
                            <td>100 prompts</td>
                        </tr>
                        <tr>
                            <td>Daily Optimization Attempts</td>
                            <td>3</td>
                            <td>50</td>
                        </tr>
                        <tr>
                            <td>Quick Prompt Input</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Basic Prompt Library</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Multi-device Sync</td>
                            <td><span class="check">✓</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Prompt Categories</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Advanced Search</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Custom Tags</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Data Export</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Priority Support</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                        <tr>
                            <td>Early Access to New Features</td>
                            <td><span class="x">✕</span></td>
                            <td><span class="check">✓</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="faq">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-items">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How does the billing work?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>For monthly plans, you will be billed every month on the same date you initially subscribed. For annual plans, you will be billed once per year. All plans automatically renew unless cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Can I upgrade from monthly to annual?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, you can upgrade from a monthly to an annual subscription at any time. When you upgrade, you'll be charged for the annual plan, and your monthly subscription will be cancelled.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How do I cancel my subscription?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>You can cancel your subscription at any time through the AetherFlow extension settings or by accessing the customer portal. After cancellation, you'll still have access to Pro features until the end of your current billing period.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>What happens to my data if I downgrade?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>If you downgrade from Pro to Free, all your prompts will be preserved, but you'll only be able to actively use 5 prompts. The rest will be marked as read-only until you upgrade again.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Do you offer refunds?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes, we offer a 14-day refund window for new subscriptions. If you're not satisfied with our service during this period, you may request a full refund. Please refer to our <a href="refund-policy.html">Refund Policy</a> for more details.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Which payment methods do you accept?</h3>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">
                        <p>We accept all major credit cards (Visa, MasterCard, American Express), as well as PayPal. All payments are securely processed through Paddle, our payment processor.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta">
        <div class="container">
            <h2>Ready to Enhance Your AI Experience?</h2>
            <p>Join thousands of users who are getting better results with AetherFlow Pro</p>
            <a href="#" class="btn btn-large" onclick="scrollToPlans()">Choose Your Plan</a>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>AetherFlow</h2>
                    <p>AI Prompt Management Chrome Extension</p>
                </div>
                <div class="footer-links">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="refund-policy.html">Refund Policy</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="https://chrome.google.com/webstore/detail/aetherflow/ldpadjcdbfndeghcklogoppmbnmphbki">Chrome Store</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <p>Email: support@aetherflow.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 AetherFlow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化FAQ切换
            const faqQuestions = document.querySelectorAll('.faq-question');
            
            faqQuestions.forEach(item => {
                item.addEventListener('click', function() {
                    const faqItem = item.parentNode;
                    const answer = faqItem.querySelector('.faq-answer');
                    const toggle = item.querySelector('.faq-toggle');
                    
                    // 切换class
                    faqItem.classList.toggle('open');
                    
                    // 更新切换图标
                    if (faqItem.classList.contains('open')) {
                        toggle.textContent = '-';
                        answer.style.maxHeight = answer.scrollHeight + 'px';
                    } else {
                        toggle.textContent = '+';
                        answer.style.maxHeight = '0';
                    }
                });
            });
            
            // 初始化Paddle支付
            initializePaddle();
            
            // 设置结账点击处理函数
            document.querySelector('.monthly-checkout').addEventListener('click', function(e) {
                e.preventDefault();
                openCheckout('monthly');
            });
            
            document.querySelector('.annual-checkout').addEventListener('click', function(e) {
                e.preventDefault();
                openCheckout('annual');
            });
        });
        
        // 切换月度和年度价格
        function showMonthly() {
            document.querySelector('.monthly-plan').style.display = 'block';
            document.querySelector('.annual-plan').style.display = 'none';
            document.querySelectorAll('.pricing-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.pricing-tab')[0].classList.add('active');
        }
        
        function showAnnual() {
            document.querySelector('.monthly-plan').style.display = 'none';
            document.querySelector('.annual-plan').style.display = 'block';
            document.querySelectorAll('.pricing-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.pricing-tab')[1].classList.add('active');
        }
        
        // 滚动到价格计划部分
        function scrollToPlans() {
            document.querySelector('.pricing-details').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 初始化Paddle支付系统
        function initializePaddle() {
            // 1. 检查URL参数是否有明确的环境指定
            const urlParams = new URLSearchParams(window.location.search);
            const envParam = urlParams.get('env');
            
            // 2. 判断环境
            // 明确参数指定的环境 > 域名判断环境
            let useSandbox = false;
            
            // 如果URL参数明确指定了环境
            if (envParam) {
                useSandbox = envParam === 'sandbox' || envParam === 'test';
            } else {
                // 判断开发环境
                const isLocalhost = window.location.hostname === 'localhost' || 
                                   window.location.hostname === '127.0.0.1' ||
                                   window.location.hostname.includes('github.dev');
                                   
                // 判断非生产环境
                const isNonProduction = isLocalhost || 
                                       window.location.hostname.includes('github.io') ||
                                       window.location.hostname.includes('test');
                                   
                // 非生产环境默认使用沙盒
                useSandbox = isNonProduction;
            }
            
            // 3. 设置环境和初始化Paddle
            if (useSandbox) {
                Paddle.Environment.set('sandbox');
                console.log('Using Paddle SANDBOX environment');
            } else {
                console.log('Using Paddle PRODUCTION environment');
            }
            
            // 初始化Paddle
            Paddle.Initialize({
                token: useSandbox ? 'test_c624a7a4c9993fc8965d9c37db6' : 'live_74080bad93a7d3b962f98a52c93',
                eventCallback: function(eventData) {
                    console.log('Paddle event:', eventData);
                    
                    // 处理结账事件
                    if (eventData.name === 'checkout.completed') {
                        // 支付成功，处理跳转
                        handleCheckoutCompleted(eventData.data);
                    }
                }
            });
            
            // 4. 记录当前环境，用于调试和测试
            localStorage.setItem('aetherflow_env', useSandbox ? 'sandbox' : 'production');
            
            // 如果需要在UI上显示当前环境（仅在非生产环境）
            if (useSandbox) {
                const envIndicator = document.createElement('div');
                envIndicator.style.position = 'fixed';
                envIndicator.style.bottom = '10px';
                envIndicator.style.left = '10px';
                envIndicator.style.padding = '5px 10px';
                envIndicator.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                envIndicator.style.color = '#900';
                envIndicator.style.borderRadius = '4px';
                envIndicator.style.fontSize = '12px';
                envIndicator.style.zIndex = '9999';
                envIndicator.textContent = 'SANDBOX MODE';
                document.body.appendChild(envIndicator);
            }
        }
        
        // 打开结账窗口
        function openCheckout(planType) {
            // 获取来源信息
            const source = getUtmSource();
            
            // 确定使用哪个价格ID
            const priceId = getPriceIdForPlan(planType);
            
            // 准备自定义数据
            const customData = {
                plan: planType,
                source: source || 'website',
                referrer: document.referrer || 'direct'
            };
            
            // 获取URL参数并传递
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('utm_campaign')) {
                customData.utm_campaign = urlParams.get('utm_campaign');
            }
            if (urlParams.has('utm_content')) {
                customData.utm_content = urlParams.get('utm_content');
            }
            
            // 打开Paddle结账
            Paddle.Checkout.open({
                items: [
                    {
                        priceId: priceId,
                        quantity: 1
                    }
                ],
                customData: customData,
                settings: {
                    displayMode: 'overlay',
                    theme: 'light',
                    locale: 'en',
                    successUrl: getSuccessUrl(planType, source)
                }
            });
        }
        
        // 根据计划类型获取价格ID
        function getPriceIdForPlan(planType) {
            // 获取当前环境
            const useSandbox = localStorage.getItem('aetherflow_env') === 'sandbox';
            
            // 根据环境和计划类型返回对应的价格ID
            if (useSandbox) {
                // 沙盒环境的价格ID
                return planType === 'annual' ? 'pri_01jrw0f7y1kfw9jc967eswbnrs' : 'pri_01jrw0em3kydrg4rw523w6s574';
            } else {
                // 生产环境的价格ID
                return planType === 'annual' ? 'pri_01jrfcz25f4zdktr7rtt1pnzpw' : 'pri_01jrfcwajex91zya4346h9ek32';
            }
        }
        
        // 获取UTM来源
        function getUtmSource() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('utm_source') || localStorage.getItem('aetherflow_utm_source') || null;
        }
        
        // 构建成功URL
        function getSuccessUrl(planType, source) {
            // 获取基础URL
            let baseUrl;
            
            // 检查环境
            const useSandbox = localStorage.getItem('aetherflow_env') === 'sandbox';
            
            // 如果是localhost，使用相对路径
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                baseUrl = '/success.html';
            } else {
                // 使用完整URL
                baseUrl = window.location.origin + '/success.html';
            }
            
            // 构建URL参数
            const params = new URLSearchParams();
            params.set('plan', planType);
            if (source) {
                params.set('source', source);
            }
            
            // 添加环境参数（仅在沙盒环境）
            if (useSandbox) {
                params.set('env', 'sandbox');
            }
            
            return baseUrl + '?' + params.toString();
        }
        
        // 处理结账完成事件
        function handleCheckoutCompleted(data) {
            console.log('Checkout completed:', data);
            
            // 从事件数据中获取信息
            const checkoutId = data.checkout?.id;
            const planType = data.items?.[0]?.price?.productType || 'monthly';
            
            // 构建跳转URL
            let redirectUrl = 'success.html?checkout=' + encodeURIComponent(checkoutId) + '&plan=' + planType;
            
            // 跳转到成功页面
            window.location.href = redirectUrl;
        }
        
        // 保存UTM来源到localStorage（如果存在）
        function saveUtmParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('utm_source')) {
                localStorage.setItem('aetherflow_utm_source', urlParams.get('utm_source'));
            }
            if (urlParams.has('utm_campaign')) {
                localStorage.setItem('aetherflow_utm_campaign', urlParams.get('utm_campaign'));
            }
        }
        
        // 在页面加载时保存UTM参数
        saveUtmParameters();
    </script>
    
    <!-- 认证相关脚本 -->
    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyCulWQxvrzxDOLGOxzi2ngj9n0DwzvqJFw",
            authDomain: "aetherflow-b6459.firebaseapp.com",
            projectId: "aetherflow-b6459",
            storageBucket: "aetherflow-b6459.firebasestorage.app",
            messagingSenderId: "423266303314",
            appId: "1:423266303314:web:9cbf8adb847f043bd34e8b",
            measurementId: "G-ZD5E2WY22N"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        
        // DOM元素
        const authButton = document.getElementById('auth-button');
        const authContainer = document.getElementById('auth-container');
        const userMenu = document.getElementById('auth-user-menu');
        const userDisplayName = document.getElementById('user-display-name');
        const userDropdown = document.getElementById('auth-user-dropdown');
        const logoutButton = document.getElementById('logout-button');
        
        const modalOverlay = document.getElementById('auth-modal-overlay');
        const modalClose = document.getElementById('auth-modal-close');
        
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const resetForm = document.getElementById('reset-form');
        
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginSubmit = document.getElementById('login-submit');
        
        const registerName = document.getElementById('register-name');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const registerSubmit = document.getElementById('register-submit');
        
        const resetEmail = document.getElementById('reset-email');
        const resetSubmit = document.getElementById('reset-submit');
        const backToLogin = document.getElementById('back-to-login');
        const forgotPassword = document.getElementById('forgot-password');
        
        const googleLogin = document.getElementById('google-login');
        
        const authLoading = document.getElementById('auth-loading');
        const successMessage = document.getElementById('auth-success-message');
        
        // 显示/隐藏加载状态
        function toggleLoading(show) {
            if (show) {
                authLoading.classList.add('show');
            } else {
                authLoading.classList.remove('show');
            }
        }
        
        // 显示成功消息
        function showSuccessMessage(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 5000);
        }
        
        // 显示错误消息
        function showError(element, message) {
            const errorElement = document.getElementById(`${element}-error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }
        
        // 清除错误消息
        function clearErrors() {
            const errorElements = document.querySelectorAll('.auth-form-error');
            errorElements.forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
        }
        
        // 打开认证模态框
        function openAuthModal() {
            modalOverlay.classList.add('active');
        }
        
        // 关闭认证模态框
        function closeAuthModal() {
            modalOverlay.classList.remove('active');
            clearErrors();
            successMessage.classList.remove('show');
        }
        
        // 切换标签页
        function switchTab(tab) {
            // 移除所有活跃标签和表单
            loginTab.classList.remove('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            resetForm.classList.remove('active');
            
            // 设置活跃标签和表单
            if (tab === 'login') {
                loginTab.classList.add('active');
                loginForm.classList.add('active');
            } else if (tab === 'register') {
                registerTab.classList.add('active');
                registerForm.classList.add('active');
            } else if (tab === 'reset') {
                resetForm.classList.add('active');
            }
            
            clearErrors();
        }
        
        // 检查URL令牌并自动登录
        function checkAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                // 使用令牌登录
                toggleLoading(true);
                firebase.auth().signInWithCustomToken(token)
                    .then(() => {
                        // 清除URL参数
                        const newUrl = window.location.pathname + window.location.hash;
                        window.history.replaceState({}, document.title, newUrl);
                    })
                    .catch(error => {
                        console.error("认证失败", error);
                    })
                    .finally(() => {
                        toggleLoading(false);
                    });
            }
        }
        
        // 更新UI显示
        function updateAuthUI(user) {
            if (user) {
                // 用户已登录
                authButton.style.display = 'none';
                userMenu.style.display = 'block';
                userDisplayName.textContent = user.displayName || user.email;
            } else {
                // 用户未登录
                authButton.style.display = 'block';
                userMenu.style.display = 'none';
            }
        }
        
        // 事件监听器
        authButton.addEventListener('click', () => {
            openAuthModal();
            switchTab('login');
        });
        
        userDisplayName.addEventListener('click', () => {
            userDropdown.classList.toggle('active');
        });
        
        logoutButton.addEventListener('click', () => {
            firebase.auth().signOut();
            userDropdown.classList.remove('active');
        });
        
        modalClose.addEventListener('click', closeAuthModal);
        
        loginTab.addEventListener('click', () => switchTab('login'));
        registerTab.addEventListener('click', () => switchTab('register'));
        
        forgotPassword.addEventListener('click', (e) => {
            e.preventDefault();
            switchTab('reset');
        });
        
        backToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            switchTab('login');
        });
        
        // 点击模态框外部关闭
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeAuthModal();
            }
        });
        
        // 表单提交处理
        loginSubmit.addEventListener('click', () => {
            clearErrors();
            
            const email = loginEmail.value.trim();
            const password = loginPassword.value;
            
            if (!email) {
                showError('login-email', 'Email is required');
                return;
            }
            
            if (!password) {
                showError('login-password', 'Password is required');
                return;
            }
            
            toggleLoading(true);
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => {
                    closeAuthModal();
                })
                .catch(error => {
                    console.error("Login failed", error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        showError('login-password', 'Invalid email or password');
                    } else {
                        showError('login-password', error.message);
                    }
                })
                .finally(() => {
                    toggleLoading(false);
                });
        });
        
        registerSubmit.addEventListener('click', () => {
            clearErrors();
            
            const name = registerName.value.trim();
            const email = registerEmail.value.trim();
            const password = registerPassword.value;
            
            if (!name) {
                showError('register-name', 'Name is required');
                return;
            }
            
            if (!email) {
                showError('register-email', 'Email is required');
                return;
            }
            
            if (!password) {
                showError('register-password', 'Password is required');
                return;
            }
            
            if (password.length < 6) {
                showError('register-password', 'Password must be at least 6 characters');
                return;
            }
            
            toggleLoading(true);
            
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    closeAuthModal();
                })
                .catch(error => {
                    console.error("Registration failed", error);
                    if (error.code === 'auth/email-already-in-use') {
                        showError('register-email', 'Email is already in use');
                    } else {
                        showError('register-password', error.message);
                    }
                })
                .finally(() => {
                    toggleLoading(false);
                });
        });
        
        resetSubmit.addEventListener('click', () => {
            clearErrors();
            
            const email = resetEmail.value.trim();
            
            if (!email) {
                showError('reset-email', 'Email is required');
                return;
            }
            
            toggleLoading(true);
            
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    showSuccessMessage('Password reset email sent. Check your inbox.');
                    resetEmail.value = '';
                })
                .catch(error => {
                    console.error("Password reset failed", error);
                    if (error.code === 'auth/user-not-found') {
                        showError('reset-email', 'No account found with this email');
                    } else {
                        showError('reset-email', error.message);
                    }
                })
                .finally(() => {
                    toggleLoading(false);
                });
        });
        
        googleLogin.addEventListener('click', () => {
            clearErrors();
            toggleLoading(true);
            
            const provider = new firebase.auth.GoogleAuthProvider();
            
            firebase.auth().signInWithPopup(provider)
                .then(() => {
                    closeAuthModal();
                })
                .catch(error => {
                    console.error("Google login failed", error);
                    showError('login-password', error.message);
                })
                .finally(() => {
                    toggleLoading(false);
                });
        });
        
        // 监听认证状态变化
        firebase.auth().onAuthStateChanged(user => {
            updateAuthUI(user);
        });
        
        // 检查URL令牌
        checkAuthToken();
        
        // 处理从扩展跳转过来的支付请求
        document.addEventListener('DOMContentLoaded', () => {
            const monthlyCheckout = document.querySelector('.monthly-checkout');
            const annualCheckout = document.querySelector('.annual-checkout');
            
            if (monthlyCheckout) {
                monthlyCheckout.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleCheckoutClick('monthly');
                });
            }
            
            if (annualCheckout) {
                annualCheckout.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleCheckoutClick('annual');
                });
            }
        });
        
        // 处理支付点击，检查登录状态
        function handleCheckoutClick(planType) {
            const currentUser = firebase.auth().currentUser;
            
            if (!currentUser) {
                // 用户未登录，显示登录框
                openAuthModal();
                switchTab('login');
                
                // 在localStorage中保存计划类型，用户登录后继续支付流程
                localStorage.setItem('aetherflow_pending_checkout', planType);
                return;
            }
            
            // 用户已登录，直接继续支付流程
            initializeCheckout(planType, currentUser.uid);
        }
        
        // 在登录状态变化时检查是否有待处理的支付
        firebase.auth().onAuthStateChanged(user => {
            updateAuthUI(user);
            
            // 检查是否有待处理的支付请求
            const pendingCheckout = localStorage.getItem('aetherflow_pending_checkout');
            
            if (user && pendingCheckout) {
                // 用户登录后继续支付流程
                initializeCheckout(pendingCheckout, user.uid);
                // 清除待处理标记
                localStorage.removeItem('aetherflow_pending_checkout');
            }
        });
        
        // 初始化结账流程，包含用户ID
        function initializeCheckout(planType, userId) {
            // 检查环境
            const useSandbox = localStorage.getItem('aetherflow_env') === 'sandbox';
            const vendorId = useSandbox ? '16291' : '17071'; // 沙盒/生产环境的vendorId
            const productIds = {
                monthly: useSandbox ? 'pro-monthly-sandbox' : 'pro-monthly',
                annual: useSandbox ? 'pro-annual-sandbox' : 'pro-annual'
            };
            
            const productId = productIds[planType];
            if (!productId) {
                console.error('无效的计划类型:', planType);
                return;
            }
            
            // 获取UTM参数
            const utmSource = localStorage.getItem('aetherflow_utm_source') || '';
            const utmCampaign = localStorage.getItem('aetherflow_utm_campaign') || '';
            
            // 构建客户数据
            const customer = {
                email: firebase.auth().currentUser?.email || ''
            };
            
            // 构建自定义数据，包括用户ID
            const passthrough = JSON.stringify({
                userId: userId,
                utmSource: utmSource,
                utmCampaign: utmCampaign,
                env: useSandbox ? 'sandbox' : 'production'
            });
            
            // 创建结账对象
            Paddle.Environment.set(useSandbox ? 'sandbox' : 'production');
            Paddle.Setup({ vendor: vendorId });
            
            // 打开结账界面
            Paddle.Checkout.open({
                product: productId,
                email: customer.email,
                passthrough: passthrough,
                successCallback: handleCheckoutCompleted
            });
        }
    </script>
</body>
</html> 